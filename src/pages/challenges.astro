---
import Layout from '~/layouts/PageLayout.astro'

const metadata = {
  title: 'Challenges â€” TNX6',
  ignoreTitleTemplate: true,
}
---

<Layout metadata={metadata}>
  <section class="max-w-6xl mx-auto py-20 px-6 text-white">
    <h1 class="text-5xl font-extrabold text-center mb-14 bg-gradient-to-r from-[#ffda6a] to-[#c29200] bg-clip-text text-transparent drop-shadow-[0_0_12px_rgba(198,164,79,0.5)] tracking-wider">
      CHALLENGES
    </h1>

    <div id="root" class="space-y-14"></div>
  </section>

  <script is:inline data-reinit>
    function initChallenges() {
      const fmtNum = (n) => (typeof n === 'number' ? n.toLocaleString('de-DE') : n)
      const url = '/api/challenges.json'
      const root = document.getElementById('root')

      function userLabel(u) {
        if (!u) return ''
        const a = (u.user || '').toLowerCase()
        const b = (u.userName || '').toLowerCase()
        return a && b && a !== b ? `${u.user} (${u.userName})` : (u.user || u.userName || '')
      }

      function variantCard(v) {
        const showAmount = !v.isBoolean
        const reward = v.rewardItem
          ? `<div class="mt-3 flex items-center gap-2">
               <span class="inline-flex items-center px-3 py-1 rounded-md bg-gradient-to-r from-[#c6a44f]/40 to-[#f7e6ac]/40 border border-[#c6a44f]/60 shadow-[0_0_8px_rgba(198,164,79,0.4)] text-sm font-semibold text-[#0a0a0c]">
                 <iconify-icon icon="tabler:gift" class="mr-1 text-base"></iconify-icon>
                 Reward: ${v.rewardItem}
               </span>
             </div>`
          : ''
        const users = v.users || []
        const hasUsers = users.length > 0
        const usersHtml = hasUsers
          ? `<h4 class="text-sm font-semibold text-[#f7e6ac] mt-4 mb-1">Completed by:</h4><ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2">${users
              .map(
                (u) =>
                  `<li class="px-3 py-1 rounded bg-black/30 border border-[#c6a44f]/20">${userLabel(u)}</li>`
              )
              .join('')}</ul>`
          : `<div class="text-gray-400 mt-3">No one has completed this challenge yet</div>`

        return `
          <div class="p-5 rounded-2xl bg-gradient-to-br from-[#0a0a0c]/80 to-[#1a1408]/80 border border-[#c6a44f]/30 shadow-[0_0_15px_rgba(198,164,79,0.12)] backdrop-blur-md">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div class="text-lg font-semibold text-[#f7e6ac] flex flex-wrap items-center gap-3">
                ${showAmount ? `<span>Required: ${fmtNum(v.amount)}</span>` : ''}
              </div>
              ${reward}
            </div>
            ${usersHtml}
          </div>
        `
      }

      function typeBlock(t) {
        const variants = (t.variants || []).map(variantCard).join('')
        return `
          <section class="relative">
            <div class="absolute inset-x-0 -top-3 h-[2px] bg-gradient-to-r from-transparent via-[#c6a44f]/70 to-transparent"></div>
            <h2 class="text-3xl font-bold mb-6 text-center text-[#f7e6ac] uppercase tracking-wide">
              ${t.type} <span class="text-sm text-[#c6a44f] align-middle">(${t.variantCount})</span>
            </h2>
            <div class="grid gap-6">${variants}</div>
          </section>
        `
      }

      async function run() {
        try {
          const res = await fetch(url, { cache: 'no-store' })
          const data = await res.json()
          const html = (data.types || []).map(typeBlock).join('')
          root.innerHTML = html || '<div class="text-center text-gray-400">No challenges</div>'
        } catch (e) {
          root.innerHTML = '<div class="text-center text-gray-400">Failed to load challenges</div>'
        }
      }

      run()
    }

    document.addEventListener('astro:page-load', () => {
      requestAnimationFrame(() => initChallenges())
    })
  </script>

  <script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
</Layout>
